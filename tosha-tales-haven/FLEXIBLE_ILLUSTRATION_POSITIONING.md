# Система "Гибкого позиционирования иллюстраций"

## Обзор

Реализована единая модель позиционирования иллюстраций, которая упрощает и нормализует логику размещения иллюстраций в сказках. Система основана на пересечении двух независимых осей — горизонтальной и вертикальной.

## Архитектура

### Структура данных

```typescript
interface Illustration {
  id: string;
  imageUrl: string;
  position_horizontal: 'left' | 'right';  // Горизонтальная ось
  position_vertical: 'top' | 'bottom';    // Вертикальная ось
  caption?: string;
  order: number;
}
```

### Логика позиционирования

#### 1. Горизонтальная ось (position_horizontal)
- **`left`** - иллюстрация "прилипает" к левому краю колонки текста
- **`right`** - иллюстрация "прилипает" к правому краю колонки текста

#### 2. Вертикальная ось (position_vertical)
- **`top`** - иллюстрация размещается **над всем текстом сказки**
- **`bottom`** - иллюстрация размещается **после всего текста сказки**

#### 3. Итоговые позиции
- **top+left** - иллюстрация сверху слева
- **top+right** - иллюстрация сверху справа  
- **bottom+left** - иллюстрация снизу слева
- **bottom+right** - иллюстрация снизу справа

## Семантика осей

### Горизонтальная ось
Определяет, у какого края колонки текста "прилипает" иллюстрация:
- **left**: текст располагается справа от иллюстрации
- **right**: текст располагается слева от иллюстрации

### Вертикальная ось
Определяет, где относительно текста размещается иллюстрация:
- **top**: иллюстрация над всем текстом, текст обтекает её сбоку
- **bottom**: иллюстрация после всего текста, текст обтекает её сбоку

## UI в админке

### Форма добавления иллюстрации
1. **Горизонтальное положение**: селект Left / Right
2. **Вертикальное положение**: селект Top / Bottom
3. **Интерактивная мини-сетка 2×2** для быстрого выбора позиции
4. **Мгновенный предпросмотр** после изменения любого контрола

### Мини-сетка позиций
```
┌─────────┬─────────┐
│   TL    │   TR    │
│ (Top-   │ (Top-   │
│  Left)  │  Right) │
├─────────┼─────────┤
│   BL    │   BR    │
│(Bottom- │(Bottom- │
│  Left)  │  Right) │
└─────────┴─────────┘
```

## Предпросмотр

### Визуальное отображение
- **Реалистичное обтекание**: текстовый блок занимает оставшуюся ширину рядом с иллюстрацией
- **Минимальные отступы**: `gap: 16px` между иллюстрацией и текстом
- **Респонсивность**: на узких экранах иллюстрация уходит над/под текст на всю ширину

### Адаптивность
- **Desktop**: иллюстрация и текст располагаются рядом согласно выбранной позиции
- **Mobile**: иллюстрация размещается над/под текстом, горизонтальная ось игнорируется

## Множественные иллюстрации

### Порядок рендера
- **Поле `order`** определяет порядок внутри каждой зоны
- **top/* иллюстрации**: рендерятся сверху вниз по `order`
- **bottom/* иллюстрации**: рендерятся сверху вниз по `order`

### Группировка
Если несколько иллюстраций в одной зоне (например, `top+left`), они **стекаются по вертикали** с одинаковым `gap`.

## Миграция

### Правила преобразования
- **Старые `align=left/right`** → `position_horizontal=left/right`, `position_vertical=top`
- **Старые `align=center`** → `position_horizontal=left`, `position_vertical=top`
- **Старые "внизу страницы"** → `position_vertical=bottom`, `position_horizontal=left`

### Скрипт миграции
```bash
cd tosha-tales-backend
node scripts/migrate-illustration-positioning.js
```

## Техническая реализация

### Backend (Prisma Schema)
```prisma
model StoryIllustration {
  id                    String @id @default(cuid())
  imageUrl              String
  position_horizontal   String @default("left") // left, right
  position_vertical     String @default("top")  // top, bottom
  caption               String?
  order                 Int
  storyId               String
  story                 Story  @relation(fields: [storyId], references: [id], onDelete: Cascade)
}
```

### Frontend (React Components)
- **StoryContent**: основной компонент для рендеринга сказки с иллюстрациями
- **StoryIllustration**: компонент отдельной иллюстрации
- **AdminStories**: форма добавления/редактирования иллюстраций

### CSS/Layout
- **Grid/Flexbox**: без использования float для стабильности
- **Зоны позиционирования**: четкое разделение на top/bottom и left/right
- **Отступы**: стабильные `gap` между элементами

## Валидация

### Backend валидация
- `position_horizontal`: только `'left' | 'right'`
- `position_vertical`: только `'top' | 'bottom'`
- `order`: целое число ≥ 0

### Frontend валидация
- Контролы ограничены допустимыми значениями
- Мгновенная обратная связь при выборе позиции

## Доступность

### Alt-тексты
- Сохраняются и рендерятся для всех иллюстраций
- Поддержка скринридеров

### Управление
- Фокусируемые элементы имеют доступные лейблы
- `aria-describedby` с подсказкой "Положение иллюстрации"
- Клавиатурная навигация по мини-сетке

## Производительность

### Оптимизации
- **Предпросмотр**: обновление < 150 мс
- **Индексы БД**: оптимизированные запросы по позициям
- **Кэширование**: эффективная группировка иллюстраций

### Кроссбраузерность
- **Chrome**: последние 2 версии
- **Firefox**: последние 2 версии  
- **Safari**: последние 2 версии
- **Edge**: последние 2 версии

## API Endpoints

### CRUD операции
- `GET /api/stories/:storyId/illustrations` - получение иллюстраций
- `POST /api/stories/:storyId/illustrations` - добавление иллюстрации
- `PUT /api/stories/:storyId/illustrations/:id` - обновление иллюстрации
- `DELETE /api/stories/:storyId/illustrations/:id` - удаление иллюстрации
- `PUT /api/stories/:storyId/illustrations/reorder` - изменение порядка

### Поля запроса/ответа
```json
{
  "imageUrl": "string",
  "position_horizontal": "left" | "right",
  "position_vertical": "top" | "bottom",
  "caption": "string?",
  "order": "number"
}
```

## Примеры использования

### Пример 1: Заголовочная иллюстрация
```typescript
{
  imageUrl: "header.jpg",
  position_horizontal: "left",
  position_vertical: "top",
  caption: "Главные герои сказки",
  order: 1
}
```
**Результат**: Иллюстрация отображается над всем текстом, прилипая к левому краю.

### Пример 2: Заключительная иллюстрация
```typescript
{
  imageUrl: "ending.jpg",
  position_horizontal: "right",
  position_vertical: "bottom",
  caption: "Счастливый конец",
  order: 3
}
```
**Результат**: Иллюстрация отображается после всего текста, прилипая к правому краю.

## Преимущества новой системы

### 1. Простота
- ✅ Только 2 оси вместо множества режимов
- ✅ Интуитивное понимание позиционирования
- ✅ Предсказуемое поведение

### 2. Гибкость
- ✅ 4 четкие позиции для любой иллюстрации
- ✅ Легкое переключение между позициями
- ✅ Поддержка множественных иллюстраций

### 3. Производительность
- ✅ Быстрый предпросмотр (< 150 мс)
- ✅ Оптимизированные запросы к БД
- ✅ Эффективный рендеринг

### 4. Совместимость
- ✅ Автоматическая миграция старых данных
- ✅ Обратная совместимость API
- ✅ Кроссбраузерная поддержка

## Тестирование

### Ручное тестирование
1. **Создайте сказку** с несколькими абзацами текста
2. **Добавьте иллюстрации** с разными позициями
3. **Проверьте предпросмотр** в админке
4. **Просмотрите публичную сказку** для сравнения

### Автоматизированное тестирование
- Unit тесты для компонентов
- Integration тесты для API
- E2E тесты для полного цикла

## Поддержка и развитие

### Документация
- [README для редактора](README.md)
- [Описание API](API.md)
- [Руководство по миграции](MIGRATION.md)

### Обратная связь
- GitHub Issues для багов
- Feature Requests для новых возможностей
- Документация обновляется регулярно

---

**Версия**: 1.0.0  
**Дата**: 2024-12-01  
**Автор**: Tales Development Team
