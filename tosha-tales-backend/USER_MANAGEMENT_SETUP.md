# Настройка управления пользователями

## Обзор

Система управления пользователями предоставляет полный CRUD функционал для администраторов с поддержкой:
- Создания, редактирования и удаления пользователей
- Управления ролями (в настоящее время только ADMIN)
- Сброса паролей
- Активации/деактивации пользователей
- Аудита действий

## Установка и настройка

### 1. Обновление базы данных

После внесения изменений в схему Prisma выполните миграцию:

```bash
npx prisma migrate dev --name update-user-model
```

### 2. Установка зависимостей

```bash
npm install bcrypt zod
```

### 3. Создание первого администратора

Используйте скрипт для создания первого администратора:

```bash
node scripts/create-admin.js
```

Следуйте инструкциям в консоли для ввода данных пользователя.

## Структура API

### Endpoints

- `GET /api/users` - Получить список пользователей с пагинацией
- `GET /api/users/:id` - Получить пользователя по ID
- `POST /api/users` - Создать нового пользователя
- `PUT /api/users/:id` - Обновить пользователя
- `POST /api/users/change-password` - Изменить пароль
- `POST /api/users/reset-password` - Сбросить пароль
- `PATCH /api/users/:id/toggle-status` - Активировать/деактивировать
- `DELETE /api/users/:id` - Удалить пользователя

### Параметры запросов

#### GET /api/users
- `page` - Номер страницы (по умолчанию 1)
- `limit` - Количество записей на странице (по умолчанию 10)
- `search` - Поиск по email или имени
- `sortBy` - Поле для сортировки (email, createdAt)
- `sortOrder` - Порядок сортировки (asc, desc)

#### POST /api/users
```json
{
  "email": "admin@example.com",
  "fullName": "Иван Иванов",
  "password": "SecurePass123",
  "isActive": true
}
```

#### PUT /api/users/:id
```json
{
  "email": "admin@example.com",
  "fullName": "Иван Иванов",
  "isActive": true
}
```

#### POST /api/users/change-password
```json
{
  "currentPassword": "OldPass123",
  "newPassword": "NewPass123",
  "confirmNewPassword": "NewPass123"
}
```

#### POST /api/users/reset-password
```json
{
  "userId": "user-id-here"
}
```

## Безопасность

### Политика паролей
- Минимум 8 символов
- Обязательно: буквы верхнего и нижнего регистра, цифры
- Хеширование с использованием bcrypt (cost = 12)

### Rate Limiting
- Чувствительные операции (смена/сброс пароля): 5 запросов за 15 минут
- Общие API запросы: стандартные лимиты

### Аудит
Все действия логируются с указанием:
- ID исполнителя
- Типа действия
- ID целевого пользователя
- Метаданных
- Временной метки

## Модель данных

### User
```prisma
model User {
  id           String    @id @default(cuid())
  email        String    @unique
  fullName     String
  passwordHash String    @map("password_hash")
  role         UserRole  @default(USER)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  stories     Story[]
  ratings     StoryRating[]
  storyLikes  StoryLike[]
  charLikes   CharacterLike[]
  mediaFiles  MediaFile[]

  @@map("users")
}
```

### UserRole
```prisma
enum UserRole {
  USER
  ADMIN
}
```

## Валидация

### Создание пользователя
- Email: валидный формат, уникальность
- FullName: 2-100 символов
- Password: минимум 8 символов, сложность

### Обновление пользователя
- Email: валидный формат, уникальность (если изменяется)
- FullName: 2-100 символов

### Смена пароля
- Текущий пароль: обязателен
- Новый пароль: минимум 8 символов, сложность
- Подтверждение: должно совпадать с новым паролем

## Ограничения

### Запрещенные действия
- Удаление собственного аккаунта
- Сброс собственного пароля другим администратором
- Деактивация собственного аккаунта

### Роли
В настоящее время поддерживается только роль ADMIN. Система подготовлена для расширения ролей в будущем.

## Логирование

### Формат логов
```json
{
  "level": "info",
  "message": "User created",
  "actorId": "admin-user-id",
  "action": "CREATE_USER",
  "targetUserId": "new-user-id",
  "metadata": {
    "email": "user@example.com",
    "role": "ADMIN"
  },
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### Маскирование чувствительных данных
- Email адреса маскируются в логах при ошибках
- Пароли никогда не логируются

## Мониторинг

### Метрики
- Общее количество пользователей
- Количество активных пользователей
- Количество администраторов
- Последние действия пользователей

### Алерты
- Попытки несанкционированного доступа
- Множественные неудачные попытки входа
- Подозрительная активность

## Troubleshooting

### Частые проблемы

1. **Ошибка "bcrypt module not found"**
   - Убедитесь, что bcrypt установлен: `npm install bcrypt`
   - Проверьте совместимость версии Node.js

2. **Ошибка валидации пароля**
   - Пароль должен содержать минимум 8 символов
   - Обязательно: буквы верхнего и нижнего регистра, цифры

3. **Ошибка "User not found"**
   - Проверьте корректность ID пользователя
   - Убедитесь, что пользователь не был удален

4. **Проблемы с аутентификацией**
   - Проверьте токен авторизации
   - Убедитесь, что пользователь активен
   - Проверьте роль пользователя (должна быть ADMIN)

### Логи
Проверьте логи приложения для диагностики проблем:
- Ошибки валидации
- Проблемы с базой данных
- Ошибки аутентификации

## Разработка

### Добавление новых ролей
1. Обновите enum UserRole в schema.prisma
2. Создайте миграцию базы данных
3. Обновите валидацию в контроллере
4. Обновите UI для отображения новых ролей

### Расширение функционала
1. Добавьте новые поля в модель User
2. Обновите схемы валидации
3. Расширьте API endpoints
4. Обновите UI компоненты

## Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Убедитесь в корректности конфигурации
3. Проверьте права доступа к базе данных
4. Обратитесь к документации API
